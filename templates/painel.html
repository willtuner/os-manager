{% extends "base.html" %}

{% block title %}Painel de OS ‚Äì {{ gerente }}{% endblock %}

{% block page_title %}Ordens de Servi√ßo{% endblock %}

{% block header_actions %}
    {% if profile_picture %}
        <img src="{{ profile_picture }}" alt="Foto de Perfil" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
    {% endif %}
    {% if session.get('is_admin') %}
    <a href="{{ url_for('admin_panel') }}" class="btn btn-admin btn-sm ms-2">
      <i class="fas fa-cog me-1"></i> Painel Admin
    </a>
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --azul-escuro: #2c3e50;
        --verde-agro: #27ae60;
        --cinza-fundo: #f4f7f6;
        --cinza-borda: #dee2e6;
        --texto-escuro: #343a40;
        --texto-claro: #6c757d;
    }
    body {
        background-color: var(--cinza-fundo);
    }
    .card-os {
        border: 1px solid var(--cinza-borda);
        border-left: 5px solid var(--verde-agro);
        border-radius: .5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        background-color: #fff;
    }
    .card-header {
        background-color: #fff;
        border-bottom: 1px solid var(--cinza-borda);
        color: var(--texto-escuro);
        padding: 0.75rem 1.25rem;
    }
    .card-body {
        padding: 1.25rem;
    }
    .badge-dias {
        font-size: 0.8rem;
        padding: 0.4em 0.7em;
    }
    .btn-prats {
        background-color: var(--verde-agro);
        border-color: var(--verde-agro);
    }
    /* Estilos para o mascote */
    .mascot-container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 1.5rem;
    }
    .mascot-icon {
        font-size: 3rem;
        animation: bounce 2s infinite;
    }
    .speech-bubble {
        position: relative;
        padding: 15px;
        border-radius: 10px;
        color: white;
        flex-grow: 1;
    }
    .speech-bubble::before {
        content: '';
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
    }
    .speech-bubble.bubble-success { background-color: #28a745; }
    .speech-bubble.bubble-success::before { border-right: 10px solid #28a745; }
    .speech-bubble.bubble-info { background-color: #17a2b8; }
    .speech-bubble.bubble-info::before { border-right: 10px solid #17a2b8; }
    .speech-bubble.bubble-warning { background-color: #ffc107; color: #212529; }
    .speech-bubble.bubble-warning::before { border-right: 10px solid #ffc107; }
    .speech-bubble.bubble-danger { background-color: #dc3545; }
    .speech-bubble.bubble-danger::before { border-right: 10px solid #dc3545; }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-10px);}
        60% {transform: translateY(-5px);}
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Novo Toggle para formul√°rio de finaliza√ß√£o
    document.querySelectorAll('.btn-toggle-form').forEach(button => {
        button.addEventListener('click', () => {
            const cardBody = button.closest('.card-body');
            const formWrapper = cardBody.querySelector('.collapse-form');
            const icon = button.querySelector('i');

            formWrapper.classList.toggle('d-none');

            if (formWrapper.classList.contains('d-none')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        });
    });

    // Valida√ß√£o de formul√°rios
    const forms = document.querySelectorAll('.needs-validation');
    forms.forEach(form => {
      form.addEventListener('submit', e => {
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
        } else {
          // Opcional: Mostrar toast de sucesso simulado (o flash do servidor √© o principal)
          // const toastEl = document.getElementById('successToast'); // Crie um elemento toast no HTML se for usar
          // if (toastEl) {
          //   const toast = new bootstrap.Toast(toastEl);
          //   toast.show();
          // }
        }
        form.classList.add('was-validated');
      });
    });

    // Filtro para tabela de hist√≥rico
    const filterInput = document.querySelector('#filter-os');
    if (filterInput) { // Verifica se o input de filtro existe
        const tableRows = document.querySelectorAll('.table-modern tbody tr');
        filterInput.addEventListener('input', () => {
          const filter = filterInput.value.toLowerCase();
          tableRows.forEach(row => {
            const osNumberCell = row.cells[0];
            const observacoesCell = row.cells[3];
            
            const osNumber = osNumberCell ? osNumberCell.textContent.toLowerCase() : "";
            const observacoes = observacoesCell ? observacoesCell.textContent.toLowerCase() : "";
            
            row.style.display = (osNumber.includes(filter) || observacoes.includes(filter)) ? '' : 'none';
          });
        });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="container py-4">

  {# --- Bloco de Sauda√ß√£o com Mascote --- #}
  {% set os_count = os_pendentes|length %}
  {% if os_count == 0 %}
    {% set bubble_class = 'bubble-success' %}
    {% set message = 'Voc√™ n√£o tem nenhuma OS pendente no momento. ‚úÖ' %}
  {% elif os_count <= 5 %}
    {% set bubble_class = 'bubble-info' %}
    {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS aberta' ~ ('s' if os_count > 1 else '') ~ '. üëç' %}
  {% elif os_count <= 15 %}
    {% set bubble_class = 'bubble-warning' %}
    {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS abertas. Fique atento! ‚ö†Ô∏è' %}
  {% else %}
    {% set bubble_class = 'bubble-danger' %}
    {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS abertas. Priorize as mais antigas! üö®' %}
  {% endif %}

  <div class="mascot-container">
    <div class="mascot-icon">üöú</div>
    <div class="speech-bubble {{ bubble_class }}">
      <h5 class="fw-bold mb-1">{{ random_greeting }} {{ gerente|capitalize_name }}!</h5>
      <p class="mb-0">{{ message }}</p>
    </div>
  </div>
  {# --- Fim do Bloco de Sauda√ß√£o com Mascote --- #}

  {% if os_pendentes %}
    {% for os in os_pendentes %}
    <div class="card card-os mb-3">
      <div class="card-header">
        <h5 class="mb-0">
          <span class="badge bg-secondary me-2">OS {{ os.os }}</span>
          Frota {{ os.frota }}
        </h5>
        <div>
          {% if os.status == 'Pendente' %}
            <span class="badge bg-warning text-dark me-2">PENDENTE</span>
          {% endif %}
          <span class="badge-dias
            {% if os.dias|int > 15 %}bg-danger
            {% elif os.dias|int > 5 %}bg-warning text-dark
            {% else %}bg-success{% endif %} me-2">
            {{ os.dias }} dia{{ 's' if os.dias|int != 1 else '' }}
            {% if os.dias|int > 15 %}üö®
            {% elif os.dias|int > 5 %}‚ö†Ô∏è
            {% else %}‚úÖ
            {% endif %}
          </span>
        </div>
      </div>
      <div class="card-body">
        <div class="mb-3">
            <p class="mb-1">
              üë®‚Äçüîß
              <strong>Prestador:</strong> {{ os.prestador if os.prestador != "Prestador n√£o definido" else "N√£o definido" }}
            </p>
            <p class="mb-2">
                üóìÔ∏è
                <strong>Aberta em:</strong> {{ os.data }}
            </p>
            <p class="card-text mb-0">
              <i class="fas fa-tools me-1 text-muted"></i> {{ os.servico }}
            </p>
        </div>

        {% if os.status == 'Pendente' %}
        <div class="alert alert-warning p-2 mb-3" role="alert">
            <p class="mb-1 small"><strong>Motivo da Pend√™ncia:</strong> {{ os.status_motivo }}</p>
            <p class="small text-muted mb-0">
                Definido por: {{ os.status_definido_por }} em {{ os.status_data }}
            </p>
        </div>
        {% endif %}

        <button class="btn btn-prats btn-sm w-100 btn-toggle-form">
            <i class="fas fa-chevron-down me-1"></i> Fechar OS
        </button>

        <div class="collapse-form d-none mt-3">
            <form action="{{ url_for('finalizar_os', os_numero_str=os.os) }}"
                  method="POST"
                  class="needs-validation"
                  novalidate>
              <div class="row g-2 mb-3">
                <div class="col-md-4">
                  <label for="data_finalizacao_{{ os.os }}" class="form-label small">Data de Finaliza√ß√£o <span class="text-danger">*</span></label>
                  <input type="date" id="data_finalizacao_{{ os.os }}"
                         name="data_finalizacao"
                         class="form-control form-control-sm"
                         required
                         max="{{ today_date }}">
                  <div class="invalid-feedback">Por favor, informe a data.</div>
                </div>
                <div class="col-md-4">
                  <label for="hora_finalizacao_{{ os.os }}" class="form-label small">Hora <span class="text-danger">*</span></label>
                  <input type="time" id="hora_finalizacao_{{ os.os }}"
                         name="hora_finalizacao"
                         class="form-control form-control-sm"
                         required>
                  <div class="invalid-feedback">Por favor, informe a hora.</div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="fas fa-check-circle me-1"></i> Confirmar
                  </button>
                </div>
              </div>
              <div class="mb-2">
                <label for="observacoes_{{ os.os }}" class="form-label small">Observa√ß√µes (opcional)</label>
                <textarea id="observacoes_{{ os.os }}"
                          name="observacoes"
                          class="form-control form-control-sm"
                          rows="3"
                          placeholder="Digite suas observa√ß√µes aqui"></textarea>
              </div>
            </form>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="text-center py-5 bg-white rounded shadow-sm">
      <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
      <h4 class="text-muted">Nenhuma OS em aberto</h4>
      <p>Todas as suas ordens de servi√ßo est√£o em dia!</p>
    </div>
  {% endif %}

  <hr class="my-5">
  <h2 class="h5 mb-3">
    <i class="fas fa-history me-2 text-primary"></i> Hist√≥rico de OS Finalizadas (√öltimas 100)
  </h2>

  {% if finalizadas %}
    <div class="filter-container">
      <input type="text" id="filter-os" class="form-control form-control-sm"
             placeholder="Filtrar por n√∫mero da OS ou observa√ß√µes...">
    </div>
    <div class="table-responsive">
      <table class="table table-modern table-sm">
        <thead>
          <tr>
            <th>OS</th>
            <th>Data</th>
            <th>Hora</th>
            <th>Observa√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          {% for f in finalizadas %}
          <tr>
            <td>{{ f.os_numero }}</td>
            <td>{{ f.data_fin }}</td>
            <td>{{ f.hora_fin }}</td>
            <td>{{ f.observacoes or '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="text-center py-4 bg-white rounded shadow-sm">
      <p class="text-muted">Voc√™ ainda n√£o finalizou nenhuma OS.</p>
    </div>
  {% endif %}

  </div>
{% endblock %}
