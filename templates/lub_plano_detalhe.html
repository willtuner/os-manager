{% extends "base.html" %}

{% block title %}Detalhes do Plano: {{ plano.nome_plano }}{% endblock %}

{% block page_title %}
<a href="{{ url_for('painel_lubrificacao') }}" class="text-decoration-none text-dark">Planos de Lubrificação</a>
<i class="fas fa-angle-right mx-2"></i>
{{ plano.nome_plano }}
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0">Detalhes do Plano</h4>
        </div>
        <div class="card-body">
            <p><strong>Nome do Plano:</strong> {{ plano.nome_plano }}</p>
            <p><strong>Modelo do Veículo:</strong> {{ plano.modelo_veiculo }}</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Revisões do Plano</h4>
        </div>
        <div class="card-body">
            <!-- Formulário para Adicionar Nova Revisão -->
            <div class="mb-4 p-3 border rounded bg-light">
                <h5>Adicionar Nova Revisão</h5>
                <form action="{{ url_for('add_lub_revisao', plano_id=plano.id) }}" method="POST" class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label for="nome_revisao" class="form-label">Nome da Revisão</label>
                        <input type="text" class="form-control" id="nome_revisao" name="nome_revisao" placeholder="Ex: Revisão 400h" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="fas fa-plus-circle me-1"></i> Adicionar Revisão
                        </button>
                    </div>
                </form>
            </div>

            <!-- Lista de Revisões Existentes -->
            <div class="accordion" id="accordionRevisoes">
                {% for revisao in plano.revisoes|sort(attribute='nome_revisao') %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading-revisao-{{ revisao.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-revisao-{{ revisao.id }}" aria-expanded="false" aria-controls="collapse-revisao-{{ revisao.id }}">
                            <strong>{{ revisao.nome_revisao }}</strong>
                        </button>
                    </h2>
                    <div id="collapse-revisao-{{ revisao.id }}" class="accordion-collapse collapse" data-bs-parent="#accordionRevisoes">
                        <div class="accordion-body">
                            <div class="d-flex justify-content-end mb-3">
                                <form action="{{ url_for('delete_lub_revisao', revisao_id=revisao.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja remover esta revisão e todos os seus itens?');">
                                    <button type="submit" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash-alt me-1"></i> Remover Revisão
                                    </button>
                                </form>
                            </div>

                            <h6>Itens da Revisão</h6>
                            <table class="table table-bordered table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Sistema</th>
                                        <th>Subsistema</th>
                                        <th>Componente (Código PIMNS)</th>
                                        <th style="width: 10%;">Qtd.</th>
                                        <th style="width: 10%;">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in revisao.itens %}
                                    <tr>
                                        <td>{{ item.subsistema.sistema.nome }}</td>
                                        <td>{{ item.subsistema.nome }}</td>
                                        <td>{{ item.componente.nome }} ({{ item.componente.codigo_pimns }})</td>
                                        <td>{{ item.quantidade }}</td>
                                        <td>
                                            <form action="{{ url_for('delete_lub_item_revisao', item_id=item.id) }}" method="POST">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remover Item">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Nenhum item adicionado a esta revisão.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>

                            <hr class="my-4">

                            <h6>Adicionar Novo Item à Revisão</h6>
                            <form action="{{ url_for('add_lub_item_revisao', revisao_id=revisao.id) }}" method="POST" class="p-3 border rounded bg-light">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-3">
                                        <label class="form-label">Sistema</label>
                                        <select class="form-select sistema-select" data-revisao-id="{{ revisao.id }}" required>
                                            <option value="" selected disabled>Selecione...</option>
                                            {% for sistema in sistemas %}
                                            <option value="{{ sistema.id }}">{{ sistema.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Subsistema</label>
                                        <select class="form-select subsistema-select" name="subsistema_id" id="subsistema-select-{{ revisao.id }}" required>
                                            <option value="" selected disabled>Selecione um sistema</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Componente</label>
                                        <select class="form-select" name="componente_id" required>
                                            <option value="" selected disabled>Selecione...</option>
                                            {% for comp in componentes|sort(attribute='nome') %}
                                            <option value="{{ comp.id }}">{{ comp.nome }} ({{ comp.codigo_pimns }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Quantidade</label>
                                        <input type="number" step="any" class="form-control" name="quantidade" value="1" required>
                                    </div>
                                    <div class="col-12 d-grid mt-3">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus-circle me-1"></i> Adicionar Item
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center p-3 text-muted">
                    Nenhuma revisão cadastrada para este plano.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sistemaSelects = document.querySelectorAll('.sistema-select');

    sistemaSelects.forEach(select => {
        select.addEventListener('change', function() {
            const sistemaId = this.value;
            const revisaoId = this.dataset.revisaoId;
            const subsistemaSelect = document.getElementById(`subsistema-select-${revisaoId}`);

            subsistemaSelect.innerHTML = '<option value="" selected disabled>Carregando...</option>';

            if (!sistemaId) {
                subsistemaSelect.innerHTML = '<option value="" selected disabled>Selecione um sistema primeiro</option>';
                return;
            }

            fetch(`/api/subsistemas/${sistemaId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    subsistemaSelect.innerHTML = '<option value="" selected disabled>Selecione um subsistema</option>';
                    data.forEach(subsistema => {
                        const option = document.createElement('option');
                        option.value = subsistema.id;
                        option.textContent = subsistema.nome;
                        subsistemaSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar subsistemas:', error);
                    subsistemaSelect.innerHTML = '<option value="" selected disabled>Erro ao carregar</option>';
                });
        });
    });
});
</script>
{% endblock %}
