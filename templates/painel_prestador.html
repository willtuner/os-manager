{% extends "base.html" %}

{% block title %}Painel de OS ‚Äì {{ nome }}{% endblock %}

{% block page_title %}Painel do Prestador{% endblock %}

{% block content %}
<style>
    :root {
        --azul-escuro: #2c3e50;
        --verde-agro: #27ae60; /* Verde Prats original, um pouco mais escuro */
        --verde-prats-claro: #2ecc71; /* Um verde um pouco mais claro para hover/detalhes */
        --cinza-fundo: #f4f7f6;
        --cinza-borda: #dee2e6;
        --texto-escuro: #343a40;
        --texto-claro: #6c757d;
    }
    body {
        background-color: var(--cinza-fundo);
    }
    .container {
        margin-top: 1rem !important; /* Ajuste para espa√ßamento superior */
        padding: 15px;
    }
    .card-os {
        border: 1px solid var(--cinza-borda);
        border-left: 5px solid var(--verde-agro);
        border-radius: .5rem; /* Bordas mais suaves */
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card-body {
        padding: 1rem 1.25rem;
    }
    .card-title .badge {
        font-size: 0.9em;
    }
    .form-label.small {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--texto-claro);
        margin-bottom: 0.2rem;
    }
    .form-control-sm {
        font-size: 0.875rem;
        border-radius: 0.25rem; /* Bordas suaves para inputs */
    }
    .btn-success {
        background-color: var(--verde-agro);
        border-color: var(--verde-agro);
        font-weight: 500;
    }
    .btn-success:hover {
        background-color: var(--verde-prats-claro); /* Usando o tom mais claro */
        border-color: var(--verde-prats-claro);
    }
    .btn-outline-primary {
        color: var(--verde-agro);
        border-color: var(--verde-agro);
    }
    .btn-outline-primary:hover {
        background-color: var(--verde-agro);
        color: white;
    }
    .text-muted {
        color: var(--texto-claro) !important;
    }
    .modal-header { /* Para o modal de detalhes */
        background-color: var(--verde-agro);
        color: white;
    }
    .modal-header .btn-close {
        filter: brightness(0) invert(1); /* Para o X do modal ficar branco */
    }
    .empty-state-icon {
        font-size: 3.5rem;
        color: var(--verde-agro);
    }
    .form-section-divider {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        border-top: 1px solid var(--cinza-borda);
    }
    .finalization-header {
        font-size: 1rem;
        font-weight: 500;
        color: var(--verde-agro);
        margin-bottom: 0.75rem;
    }

    /* Estilos para o mascote */
    .mascot-container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 1.5rem;
    }
    .mascot-icon {
        font-size: 3rem;
        animation: bounce 2s infinite;
    }
    .speech-bubble {
        position: relative;
        padding: 15px;
        border-radius: 10px;
        color: white;
        flex-grow: 1;
    }
    .speech-bubble::before {
        content: '';
        position: absolute;
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        border-top: 10px solid transparent;
        border-bottom: 10px solid transparent;
    }
    .speech-bubble.bubble-success { background-color: #28a745; }
    .speech-bubble.bubble-success::before { border-right: 10px solid #28a745; }
    .speech-bubble.bubble-info { background-color: #17a2b8; }
    .speech-bubble.bubble-info::before { border-right: 10px solid #17a2b8; }
    .speech-bubble.bubble-warning { background-color: #ffc107; color: #212529; }
    .speech-bubble.bubble-warning::before { border-right: 10px solid #ffc107; }
    .speech-bubble.bubble-danger { background-color: #dc3545; }
    .speech-bubble.bubble-danger::before { border-right: 10px solid #dc3545; }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-10px);}
        60% {transform: translateY(-5px);}
    }

    /* Estilos para as abas */
    .nav-tabs .nav-link {
        color: var(--azul-escuro);
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        background-color: var(--verde-agro);
        color: white;
        border-color: var(--verde-agro);
    }
</style>

<div class="container">
    {# --- Bloco de Sauda√ß√£o com Mascote --- #}
    {% set os_count = os_list|length %}
    {% if os_count == 0 %}
      {% set bubble_class = 'bubble-success' %}
      {% set message = 'Voc√™ n√£o tem nenhuma OS pendente no momento. ‚úÖ' %}
    {% elif os_count <= 5 %}
      {% set bubble_class = 'bubble-info' %}
      {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS aberta' ~ ('s' if os_count > 1 else '') ~ '. üëç' %}
    {% elif os_count <= 15 %}
      {% set bubble_class = 'bubble-warning' %}
      {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS abertas. Fique atento! ‚ö†Ô∏è' %}
    {% else %}
      {% set bubble_class = 'bubble-danger' %}
      {% set message = 'Voc√™ tem ' ~ os_count ~ ' OS abertas. Priorize as mais antigas! üö®' %}
    {% endif %}

    <div class="mascot-container">
        <div class="mascot-icon">üöú</div>
        <div class="speech-bubble {{ bubble_class }}">
            <h5 class="fw-bold mb-1" id="greeting-text">{{ nome|capitalize_name }}!</h5>
            <p class="mb-0">{{ message }}</p>
        </div>
    </div>
    {# --- Fim do Bloco de Sauda√ß√£o com Mascote --- #}

    <!-- ABAS DE NAVEGA√á√ÉO -->
    <ul class="nav nav-tabs mb-4" id="prestadorTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="ativas-tab" data-bs-toggle="tab" data-bs-target="#ativas" type="button" role="tab" aria-controls="ativas" aria-selected="true">
                <i class="fas fa-wrench me-1"></i> OS Ativas <span class="badge bg-primary ms-2">{{ os_list|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="false">
                <i class="fas fa-history me-1"></i> Meu Hist√≥rico
            </button>
        </li>
    </ul>

    <!-- CONTE√öDO DAS ABAS -->
    <div class="tab-content" id="prestadorTabContent">
        <!-- ABA DE OS ATIVAS -->
        <div class="tab-pane fade show active" id="ativas" role="tabpanel" aria-labelledby="ativas-tab">
            {% if os_list %}
                {% for item in os_list %}
                <div class="card card-os mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title mb-2">
                                    <span class="badge bg-dark me-2">OS {{ item.os }}</span>
                                    Frota {{ item.frota | default('N/A') }}
                                </h5>
                                <p class="card-text mb-1">
                                    <small class="text-muted">
                                        Aberta em: {{ item.data_entrada if item.data_entrada else 'Data n√£o informada' }}
                                        &bull; Modelo: {{ item.modelo | default('N/A') }}
                                    </small>
                                </p>
                                <p class="card-text mb-2">
                                    <small class="text-muted">
                                        Status: <span class="fw-bold
                                        {% if item.dias_abertos > 30 %}text-danger
                                        {% elif item.dias_abertos > 15 %}text-warning
                                        {% else %}text-primary
                                        {% endif %}">
                                        Aberta h√° {{ item.dias_abertos }} dia{% if item.dias_abertos != 1 %}s{% endif %}
                                        </span>
                                    </small>
                                </p>
                            </div>
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm ms-2 flex-shrink-0"
                                    data-bs-toggle="modal"
                                    data-bs-target="#detalhesModal-{{ item.os }}">
                                <i class="fas fa-eye me-1"></i>Detalhes
                            </button>
                        </div>

                        <p class="card-text mt-1 mb-3">
                            <i class="fas fa-wrench me-1 text-muted"></i>
                            <span style="white-space: pre-wrap;">{{ item.servico | default('Servi√ßo n√£o especificado.') }}</span>
                        </p>

                        {% if item.status == 'Pendente' %}
                        <div class="alert alert-warning p-2" role="alert">
                            <h6 class="alert-heading h6 mb-1"><i class="fas fa-pause-circle me-1"></i>OS Pendente</h6>
                            <p class="mb-1 small"><strong>Motivo:</strong> {{ item.status_motivo }}</p>
                            <p class="small text-muted mb-0">
                                Definido por: {{ item.status_definido_por }} em {{ item.status_data }}
                            </p>
                        </div>
                        {% endif %}

                        <hr class="form-section-divider">

                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-success btn-sm btn-toggle-form">
                                    <i class="fas fa-chevron-down me-1"></i> Finalizar esta OS
                                </button>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#pendenteModal-{{ item.os }}">
                                <i class="fas fa-pause-circle me-1"></i>Marcar Pendente
                            </button>
                        </div>

                        <div class="collapse-form d-none mt-3">
                            <form action="{{ url_for('finalizar_os', os_numero_str=item.os) }}"
                                  method="POST"
                                  enctype="multipart/form-data"
                                  class="needs-validation" novalidate onsubmit="return validateFinalizationForm(this, '{{ item.data_entrada }}')">

                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label for="data_finalizacao_{{ item.os }}" class="form-label small">Data de Finaliza√ß√£o <span class="text-danger">*</span></label>
                                    <input type="date" id="data_finalizacao_{{ item.os }}" name="data_finalizacao"
                                           class="form-control form-control-sm"
                                           required
                                           max="{{ today_date }}">
                                    <div class="invalid-feedback">Campo obrigat√≥rio.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="hora_finalizacao_{{ item.os }}" class="form-label small">Hora de Finaliza√ß√£o <span class="text-danger">*</span></label>
                                    <input type="time" id="hora_finalizacao_{{ item.os }}" name="hora_finalizacao"
                                           class="form-control form-control-sm"
                                           required>
                                    <div class="invalid-feedback">Campo obrigat√≥rio.</div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label for="observacoes_final_{{ item.os }}" class="form-label small">Observa√ß√µes da Finaliza√ß√£o</label>
                                <textarea id="observacoes_final_{{ item.os }}" name="observacoes"
                                          class="form-control form-control-sm"
                                          rows="3"
                                          placeholder="Descreva os detalhes da manuten√ß√£o (ex.: vazamento corrigido, pe√ßa trocada)"></textarea>
                            </div>
                             <div class="mb-3">
                                <label for="evidencia_{{ item.os }}" class="form-label small">Anexar Evid√™ncia (Opcional: Imagem ou PDF)</label>
                                <input type="file" id="evidencia_{{ item.os }}" name="evidencia"
                                       class="form-control form-control-sm"
                                       accept="image/*,.pdf">
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-success btn-sm" id="submit-btn-{{ item.os }}">
                                    <i class="fas fa-check-circle me-1"></i>Confirmar Finaliza√ß√£o
                                </button>
                            </div>
                        </form>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="detalhesModal-{{ item.os }}" tabindex="-1" aria-labelledby="detalhesModalLabel-{{ item.os }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="detalhesModalLabel-{{ item.os }}">Detalhes da OS {{ item.os }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>OS:</strong> {{ item.os }}</p>
                                <p><strong>Frota:</strong> {{ item.frota | default('N/A') }}</p>
                                <p><strong>Modelo:</strong> {{ item.modelo | default('N/A') }}</p>
                                <p><strong>Data de Entrada:</strong> {{ item.data_entrada if item.data_entrada else 'N/A' }}</p>
                                <p><strong>Dias em Aberto:</strong> {{ item.dias_abertos }}</p>
                                <hr>
                                <p><strong>Servi√ßo Solicitado:</strong></p>
                                <p style="white-space: pre-wrap;">{{ item.servico | default('N/A') }}</p>
                                {% if item.observacao or item.Observacao %}
                                    <hr>
                                    <p><strong>Observa√ß√µes de Abertura:</strong></p>
                                    <p style="white-space: pre-wrap;">{{ item.observacao or item.Observacao }}</p>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal para Marcar como Pendente -->
                <div class="modal fade" id="pendenteModal-{{ item.os }}" tabindex="-1" aria-labelledby="pendenteModalLabel-{{ item.os }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <form action="{{ url_for('marcar_pendente', os_numero=item.os) }}" method="POST" class="needs-validation" novalidate>
                                <div class="modal-header bg-warning text-dark">
                                    <h5 class="modal-title" id="pendenteModalLabel-{{ item.os }}"><i class="fas fa-pause-circle me-2"></i>Marcar OS {{ item.os }} como Pendente</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>A OS ficar√° com o status "Pendente" e ser√° destacada para o gerente e administrador.</p>
                                    <div class="mb-3">
                                        <label for="motivo_{{ item.os }}" class="form-label"><strong>Motivo da Pend√™ncia <span class="text-danger">*</span></strong></label>
                                        <textarea class="form-control" id="motivo_{{ item.os }}" name="motivo" rows="4" placeholder="Ex: Aguardando chegada de pe√ßas, Necess√°rio aprova√ß√£o do cliente, etc." required></textarea>
                                        <div class="invalid-feedback">Por favor, informe o motivo da pend√™ncia.</div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-warning text-dark"><i class="fas fa-save me-1"></i>Salvar Pend√™ncia</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5 bg-light rounded shadow-sm mt-4">
                    <i class="fas fa-check-circle empty-state-icon mb-3"></i>
                    <h4 class="text-muted">Nenhuma OS pendente</h4>
                    <p class="text-secondary">Todas as ordens de servi√ßo atribu√≠das est√£o em dia!</p>
                </div>
            {% endif %}
        </div>

        <!-- ABA DE HIST√ìRICO -->
        <div class="tab-pane fade" id="historico" role="tabpanel" aria-labelledby="historico-tab">
            <div class="list-group">
            {% if finalizadas %}
                {% for f in finalizadas %}
                <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 border rounded">
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1 text-success"><i class="fas fa-check-circle me-2"></i>OS {{ f.os_numero }}</h5>
                        <small class="text-muted" title="Registrado em {{ format_datetime(f.registrado_em) }}">Finalizada em {{ f.data_fin }}</small>
                    </div>
                    <p class="mb-1 fst-italic ps-1">"{{ f.observacoes or 'Nenhuma observa√ß√£o foi registrada.' }}"</p>
                    <small class="text-muted ps-1">Confirmado √†s {{ f.hora_fin }}.</small>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-5 bg-light rounded shadow-sm">
                    <i class="fas fa-box-open empty-state-icon mb-3" style="color: #6c757d;"></i>
                    <h4 class="text-muted">Nenhum hist√≥rico de finaliza√ß√£o</h4>
                    <p class="text-secondary">As ordens de servi√ßo que voc√™ finalizar aparecer√£o aqui.</p>
                </div>
            {% endif %}
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-sign-out-alt me-1"></i> Sair
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Script do mascote de sauda√ß√£o
    const greetings = {{ greetings_list|tojson|safe }};
    const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
    const greetingElement = document.getElementById('greeting-text');
    if (greetingElement) {
        greetingElement.innerHTML = randomGreeting + ' ' + greetingElement.innerHTML;
    }

    // Toggle para formul√°rio de finaliza√ß√£o
    document.querySelectorAll('.btn-toggle-form').forEach(button => {
        button.addEventListener('click', () => {
            const cardBody = button.closest('.card-body');
            const formWrapper = cardBody.querySelector('.collapse-form');
            const icon = button.querySelector('i');

            formWrapper.classList.toggle('d-none');

            if (formWrapper.classList.contains('d-none')) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            } else {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            }
        });
    });

    // Ativar valida√ß√£o Bootstrap
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
});

function validateFinalizationForm(form, dataAberturaStr) {
    const dataFinalizacaoInput = form.querySelector('input[name="data_finalizacao"]');
    const horaFinalizacaoInput = form.querySelector('input[name="hora_finalizacao"]');

    form.classList.add('was-validated');

    if (!dataFinalizacaoInput.value || !horaFinalizacaoInput.value) {
        if (!dataFinalizacaoInput.value) dataFinalizacaoInput.focus();
        else if (!horaFinalizacaoInput.value) horaFinalizacaoInput.focus();
        return false;
    }

    if (dataAberturaStr && dataAberturaStr !== 'Data n√£o informada' && dataAberturaStr !== '' && dataAberturaStr !== 'N/A') {
        try {
            let dataAberturaObj = null;
            const match = dataAberturaStr.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (match) {
                // Formato DD/MM/YYYY
                dataAberturaObj = new Date(`${match[3]}-${match[2]}-${match[1]}`);
            } else {
                // Tenta formato YYYY-MM-DD
                dataAberturaObj = new Date(dataAberturaStr);
            }

            if (isNaN(dataAberturaObj.getTime())) {
                throw new Error('Data de abertura inv√°lida');
            }

            const dataFinalizacaoObj = new Date(dataFinalizacaoInput.value);

            if (isNaN(dataFinalizacaoObj.getTime())) {
                 dataFinalizacaoInput.classList.add('is-invalid');
                 return false;
            }

            // Normaliza as datas para compara√ß√£o (ignora a hora)
            dataAberturaObj.setHours(0, 0, 0, 0);
            const dataFinalizacaoComp = new Date(dataFinalizacaoObj.getTime() + dataFinalizacaoObj.getTimezoneOffset() * 60000);

            if (dataFinalizacaoComp < dataAberturaObj) {
                alert('A data de finaliza√ß√£o n√£o pode ser anterior √† data de abertura da OS.');
                dataFinalizacaoInput.classList.add('is-invalid');
                return false;
            } else {
                dataFinalizacaoInput.classList.remove('is-invalid');
            }
        } catch (e) {
            console.error("Erro ao validar datas:", e);
            // N√£o bloqueia o envio se a data de abertura for inv√°lida, mas avisa.
            console.warn("N√£o foi poss√≠vel validar a data de abertura:", dataAberturaStr);
        }
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Confirmando...';
    }
    return true;
}
</script>
{% endblock %}
