{% extends "base.html" %}

{% block title %}Painel Admin – Suco Prats Agro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  :root {
    --laranja-agro: #f28c38;
    --terra-agro: #8b5a2b;
    --amarelo-john-deere: #ffc107;
    --cinza-maquina: #4a4a4a;
  }
  .stat-card {
    border: 2px solid var(--cinza-maquina);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    background: linear-gradient(135deg, var(--laranja-agro), var(--terra-agro));
    color: white;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
  }
  .stat-card h3 {
    font-size: 1.8rem;
    margin-bottom: 8px;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
  }
  .stat-card p {
    font-size: 0.9rem;
    opacity: 0.9;
  }
  .card-modern {
    border: 1px solid var(--cinza-maquina);
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    background: #fff;
  }
  .card-header {
    background: linear-gradient(135deg, var(--terra-agro), var(--cinza-maquina));
    color: white;
    padding: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .table-modern {
    background: white;
    border: 1px solid var(--cinza-maquina);
  }
  .table-modern th {
    background: var(--cinza-maquina);
    color: white;
    font-weight: 600;
    text-transform: uppercase;
  }
  .table-modern td {
    vertical-align: middle;
    font-size: 0.95rem;
    border-right: 1px solid #dee2e6;
  }
  .table-modern tr:hover {
    background: #f5f5f5;
  }
  .badge-ranking {
    font-size: 0.85rem;
    padding: 5px 10px;
    border-radius: 4px;
    color: white;
  }
  .ranking-1 { background-color: #d32f2f; }
  .ranking-2 { background-color: #f57c00; }
  .ranking-3 { background-color: #ffca28; }
  .ranking-other { background-color: var(--cinza-maquina); }
  .period-btn {
    border: 2px solid var(--cinza-maquina);
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 0.9rem;
    margin-right: 5px;
    background: #fff;
    color: var(--cinza-maquina);
    transition: all 0.3s ease;
  }
  .period-btn.active {
    background-color: var(--laranja-agro);
    border-color: var(--laranja-agro);
    color: white;
  }
  .period-btn:hover {
    background-color: var(--amarelo-john-deere);
    border-color: var(--amarelo-john-deere);
    color: #fff;
  }
  .btn-agro {
    background-color: var(--laranja-agro);
    border-color: var(--laranja-agro);
    color: white;
    border-radius: 4px;
    font-weight: 600;
    transition: all 0.3s ease;
  }
  .btn-agro:hover {
    background-color: var(--terra-agro);
    border-color: var(--terra-agro);
  }
  .chart-container {
    max-width: 100%;
    margin-bottom: 20px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid var(--cinza-maquina);
  }
  .filter-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .flatpickr-input {
    border: 2px solid var(--cinza-maquina);
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 0.9rem;
  }
  .nav-tabs {
    border-bottom: 3px solid var(--laranja-agro);
  }
  .nav-tabs .nav-link {
    border: 2px solid var(--cinza-maquina);
    border-bottom: none;
    border-radius: 0;
    color: var(--cinza-maquina);
    font-weight: 600;
    text-transform: uppercase;
    background: #fff;
    transition: all 0.3s ease;
  }
  .nav-tabs .nav-link.active {
    background-color: var(--laranja-agro);
    color: white;
    border-color: var(--laranja-agro);
  }
  .nav-tabs .nav-link:hover {
    background-color: var(--amarelo-john-deere);
    color: white;
    border-color: var(--amarelo-john-deere);
  }
  .icon-agro {
    font-size: 1.2rem;
    margin-right: 8px;
  }
  @media (max-width: 576px) {
    .stat-card h3 { font-size: 1.4rem; }
    .table-modern { font-size: 0.85rem; }
    .filter-container { flex-direction: column; align-items: stretch; }
    .period-btn { width: 100%; margin-bottom: 5px; }
    .nav-tabs .nav-link { font-size: 0.9rem; padding: 8px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar Flatpickr para intervalo de datas
    flatpickr('#date-range', {
      mode: 'range',
      dateFormat: 'Y-m-d',
      locale: {
        firstDayOfWeek: 1,
        weekdays: { shorthand: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'], longhand: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'] },
        months: { shorthand: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], longhand: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'] }
      },
      onChange: (selectedDates) => {
        if (selectedDates.length === 2) {
          const [start, end] = selectedDates;
          const url = new URL(window.location);
          url.searchParams.set('periodo', 'custom');
          url.searchParams.set('data_inicio', start.toISOString().split('T')[0]);
          url.searchParams.set('data_fim', end.toISOString().split('T')[0]);
          window.location = url;
        }
      }
    });

    // Configurar botões de período
    const periodButtons = document.querySelectorAll('.period-btn');
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const periodo = btn.dataset.periodo;
        const url = new URL(window.location);
        url.searchParams.set('periodo', periodo);
        url.searchParams.delete('data_inicio');
        url.searchParams.delete('data_fim');
        window.location = url;
      });
    });

    // Gráfico de OS por período
    const ctxPeriodo = document.getElementById('osPorPeriodo').getContext('2d');
    new Chart(ctxPeriodo, {
      type: 'bar',
      data: {
        labels: Object.keys({{ chart_data.os_por_periodo|tojson }}),
        datasets: [{
          label: 'OS Finalizadas',
          data: Object.values({{ chart_data.os_por_periodo|tojson }}),
          backgroundColor: 'rgba(242, 140, 56, 0.6)',
          borderColor: 'rgba(242, 140, 56, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });

    // Gráfico de OS por gerente
    const ctxGerente = document.getElementById('osPorGerente').getContext('2d');
    new Chart(ctxGerente, {
      type: 'pie',
      data: {
        labels: Object.keys({{ chart_data.os_por_gerente|tojson }}).map(name => name.split('.')[0].capitalize()),
        datasets: [{
          data: Object.values({{ chart_data.os_por_gerente|tojson }}),
          backgroundColor: ['#f28c38', '#8b5a2b', '#ffc107', '#d32f2f', '#388e3c', '#0288d1'],
          borderColor: '#fff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'right' } }
      }
    });

    // Filtro da tabela
    const filterInput = document.querySelector('#filter-os');
    const tableRows = document.querySelectorAll('.table-modern tbody tr');
    filterInput.addEventListener('input', () => {
      const filter = filterInput.value.toLowerCase();
      tableRows.forEach(row => {
        const osNumber = row.cells[0].textContent.toLowerCase();
        const gerente = row.cells[1].textContent.toLowerCase();
        const observacoes = row.cells[4].textContent.toLowerCase();
        row.style.display = (osNumber.includes(filter) || gerente.includes(filter) || observacoes.includes(filter)) ? '' : 'none';
      });
    });
  });

  // Função para capitalizar nomes
  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  };
</script>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0"><i class="fas fa-tractor icon-agro"></i>Painel de Manutenção Agrícola</h2>
    <div>
      <a href="{{ url_for('exportar_os_finalizadas', periodo=periodo, data_inicio=data_inicio, data_fim=data_fim) }}" class="btn btn-agro btn-sm me-2">
        <i class="fas fa-file-export me-1"></i>Exportar Relatório
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
        <i class="fas fa-sign-out-alt me-1"></i>Desconectar
      </a>
    </div>
  </div>

  <!-- Abas -->
  <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab" aria-controls="geral" aria-selected="true">
        <i class="fas fa-wrench icon-agro"></i>Visão Geral
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos" type="button" role="tab" aria-controls="graficos" aria-selected="false">
        <i class="fas fa-chart-bar icon-agro"></i>Análises Gráficas
      </button>
    </li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <!-- Aba: Visão Geral -->
    <div class="tab-pane fade show active" id="geral" role="tabpanel" aria-labelledby="geral-tab">
      <!-- Cartões de Estatísticas -->
      <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="stat-card">
            <h3><i class="fas fa-clipboard-list icon-agro"></i>{{ total_os }}</h3>
            <p>OS Concluídas</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card">
            <h3><i class="fas fa-users icon-agro"></i>{{ gerentes|length }}</h3>
            <p>Supervisores Ativos</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card">
            <h3><i class="fas fa-calendar-day icon-agro"></i>{{ now.strftime('%d/%m/%Y %H:%M:%S') }}</h3>
            <p>Última Atualização</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card">
            <h3><i class="fas fa-exclamation-circle icon-agro"></i>{{ os_abertas.values()|sum }}</h3>
            <p>OS em Aberto</p>
          </div>
        </div>
      </div>

      <!-- Filtros e Histórico de Manutenções -->
      <div class="card-modern mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-tools icon-agro"></i>Histórico de Manutenções</h4>
        </div>
        <div class="card-body">
          <div class="filter-container">
            <div class="btn-group">
              <button class="btn period-btn {% if periodo == 'todos' %}active{% endif %}" data-periodo="todos">Todas</button>
              <button class="btn period-btn {% if periodo == 'diario' %}active{% endif %}" data-periodo="diario">Diário</button>
              <button class="btn period-btn {% if periodo == 'semanal' %}active{% endif %}" data-periodo="semanal">Semanal</button>
              <button class="btn period-btn {% if periodo == 'mensal' %}active{% endif %}" data-periodo="mensal">Mensal</button>
              <button class="btn period-btn {% if periodo == 'anual' %}active{% endif %}" data-periodo="anual">Anual</button>
            </div>
            <input type="text" id="date-range" class="flatpickr-input form-control" placeholder="Intervalo de datas" value="{% if data_inicio and data_fim %}{{ data_inicio }} to {{ data_fim }}{% endif %}">
            <input type="text" id="filter-os" GELform-control form-control-sm" placeholder="Filtrar por OS, supervisor ou observações...">
          </div>
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr>
                  <th>OS</th>
                  <th>Supervisor</th>
                  <th>Data</th>
                  <th>Hora</th>
                  <th>Observações</th>
                </tr>
              </thead>
              <tbody>
                {% for os in finalizadas %}
                <tr>
                  <td>{{ os.os_numero }}</td>
                  <td>{{ os.gerente|capitalize_name }}</td>
                  <td>{{ os.data_fin }}</td>
                  <td>{{ os.hora_fin }}</td>
                  <td>{{ os.observacoes or '-' }}</td>
                </tr>
                {% endfor %}
                {% if not finalizadas %}
                <tr><td colspan="5" class="text-center py-3">Nenhuma manutenção concluída</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Rankings -->
      <div class="row">
        <div class="col-md-6">
          <div class="card-modern mb-4">
            <div class="card-header">
              <h4 class="mb-0"><i class="fas fa-trophy icon-agro"></i>Ranking OS em Aberto (Supervisores)</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-modern table-sm">
                  <thead>
                    <tr><th>Posição</th><th>Supervisor</th><th>OS em Aberto</th></tr>
                  </thead>
                  <tbody>
                    {% for gerente, count in ranking_os_abertas %}
                    <tr>
                      <td><span class="badge badge-ranking {% if loop.index == 1 %}ranking-1{% elif loop.index == 2 %}ranking-2{% elif loop.index == 3 %}ranking-3{% else %}ranking-other{% endif %}">{{ loop.index }}º</span></td>
                      <td>{{ gerente|capitalize_name }}</td>
                      <td>{{ count }} pendente{{ 's' if count != 1 else '' }}</td>
                    </tr>
                    {% endfor %}
                    {% if not ranking_os_abertas %}
                    <tr><td colspan="3" class="text-center py-3">Nenhuma OS em aberto</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card-modern mb-4">
            <div class="card-header">
              <h4 class="mb-0"><i class="fas fa-trophy icon-agro"></i>Ranking OS em Aberto (Prestadores)</h4>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-modern table-sm">
                  <thead>
                    <tr><th>Posição</th><th>Prestador</th><th>OS em Aberto</th></tr>
                  </thead>
                  <tbody>
                    {% for prestador, count in ranking_os_prestadores %}
                    <tr>
                      <td><span class="badge badge-ranking {% if loop.index == 1 %}ranking-1{% elif loop.index == 2 %}ranking-2{% elif loop.index == 3 %}ranking-3{% else %}ranking-other{% endif %}">{{ loop.index }}º</span></td>
                      <td>{{ prestador|capitalize_name }}</td>
                      <td>{{ count }} pendente{{ 's' if count != 1 else '' }}</td>
                    </tr>
                    {% endfor %}
                    {% if not ranking_os_prestadores %}
                    <tr><td colspan="3" class="text-center py-3">Nenhuma OS em aberto</td></tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Histórico de Logins -->
      <div class="card-modern">
        <div class="card-header">
          <h4 class="mb-0"><i class="fas fa-history icon-agro"></i>Histórico de Acesso (Últimos 50)</h4>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr><th>Usuário</th><th>Tipo</th><th>Login</th><th>Logout</th><th>Duração</th></tr>
              </thead>
              <tbody>
                {% for ev in login_events %}
                <tr>
                  <td>{{ ev.username|capitalize_name }}</td>
                  <td>{{ ev.user_type.capitalize() }}</td>
                  <td>{{ ev.login_time_formatted }}</td>
                  <td>{% if ev.logout_time_formatted %}{{ ev.logout_time_formatted }}{% else %}<span class="text-muted">ativo</span>{% endif %}</td>
                  <td>{% if ev.duration_secs %}{{ (ev.duration_secs // 3600) }}h {{ ((ev.duration_secs % 3600)//60) }}m {{ (ev.duration_secs % 60) }}s{% else %}<span class="text-muted">—</span>{% endif %}</td>
                </tr>
                {% endfor %}
                {% if not login_events %}
                <tr><td colspan="5" class="text-center py-3">Nenhum evento de acesso</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba: Análises Gráficas -->
    <div class="tab-pane fade" id="graficos" role="tabpanel" aria-labelledby="graficos-tab">
      <div class="row">
        <div class="col-md-6">
          <div class="card-modern mb-4">
            <div class="card-header">
              <h4 class="mb-0"><i class="fas fa-chart-bar icon-agro"></i>Manutenções por Período</h4>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="osPorPeriodo"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card-modern mb-4">
            <div class="card-header">
              <h4 class="mb-0"><i class="fas fa-chart-pie icon-agro"></i>Manutenções por Supervisor</h4>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="osPorGerente"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
