{% extends "base.html" %}

{% block title %}Painel Admin ‚Äì Suco Prats Agro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  :root {
    --azul-escuro: #2c3e50;
    --verde-agro: #27ae60;
    --laranja-suco: #f39c12;
    --vermelho-erro: #e74c3c;
    --amarelo-john-deere: #f1c40f;
    --cinza-claro: #f8f9fa;
    --ciano: #17a2b8;
    --azul: #007bff;
    --cinza-escuro: #343a40;
    --cinza-medio: #6c757d;
  }
  .container {
    background: linear-gradient(180deg, var(--cinza-claro), #fff);
    border-radius: 8px;
    padding: 10px; /* Reduzido de 20px */
    margin-top: 0 !important;
    min-height: auto; /* Alterado de 100vh para evitar espa√ßo for√ßado */
  }
  .d-flex.justify-content-between.align-items-center.mb-4 {
    margin-bottom: 0.5rem !important; /* Reduzido de 1rem */
  }
  .nav-tabs.mb-4 {
    margin-bottom: 0.5rem !important; /* Reduzido de 1rem */
  }
  .stat-card {
    background: var(--cinza-claro);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    text-align: center;
  }
  .stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .stat-card h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: white;
  }
  .stat-card p {
    font-size: 0.9rem;
    color: white;
  }
  .stat-card.primary { background-color: var(--azul-escuro); }
  .stat-card.success { background-color: var(--verde-agro); }
  .stat-card.warning { background-color: var(--laranja-suco); }
  .stat-card.danger { background-color: var(--vermelho-erro); }
  .stat-card.primary h3, .stat-card.primary p,
  .stat-card.success h3, .stat-card.success p,
  .stat-card.warning h3, .stat-card.warning p,
  .stat-card.danger h3, .stat-card.danger p {
    color: white;
  }
  .stat-card .icon-agro {
    color: white;
  }
  .card-modern {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .card-header {
    background: var(--azul-escuro);
    color: white;
    padding: 10px 15px;
    border-radius: 8px 8px 0 0;
    font-weight: 500;
  }
  .card-header.ranking-gerentes { background: var(--ciano); }
  .card-header.ranking-prestadores { background: var(--azul); }
  .card-header.historico-os { background: var(--cinza-escuro); }
  .card-header.historico-logins { background: var(--cinza-medio); }
  .table-modern {
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
  }
  .table-modern th {
    background: var(--cinza-claro);
    color: var(--azul-escuro);
    font-weight: 500;
  }
  .table-modern td {
    vertical-align: middle;
    font-size: 0.95rem;
    border-bottom: 1px solid var(--cinza-claro);
  }
  .table-modern tr:hover {
    background: var(--amarelo-john-deere);
  }
  .badge-ranking {
    font-size: 0.85rem;
    padding: 4px 7px;
    border-radius: 5px;
    color: white;
  }
  .ranking-1 { background-color: var(--vermelho-erro); }
  .ranking-2 { background-color: var(--laranja-suco); }
  .ranking-3 { background-color: var(--amarelo-john-deere); }
  .ranking-other { background-color: #95a5a6; }
  .badge-os-aberta {
    background-color: var(--vermelho-erro);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .period-btn {
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.9rem;
    margin-right: 5px;
    background: var(--cinza-claro);
    color: var(--azul-escuro);
    transition: all 0.3s ease;
  }
  .period-btn.active {
    background-color: var(--laranja-suco);
    color: white;
  }
  .period-btn:hover {
    background-color: var(--verde-agro);
    color: white;
  }
  .btn-agro {
    background-color: var(--verde-agro);
    border: none;
    color: white;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  .btn-agro:hover {
    background-color: var(--laranja-suco);
  }
  .btn-toggle {
    background-color: var(--cinza-claro);
    color: var(--azul-escuro);
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  .btn-toggle:hover {
    background-color: var(--amarelo-john-deere);
    color: white;
  }
  .chart-container {
    max-width: 100%;
    margin-bottom: 20px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .filter-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .flatpickr-input {
    border: 1px solid var(--cinza-claro);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 0.9rem;
  }
  .nav-tabs {
    border-bottom: 2px solid var(--verde-agro);
  }
  .nav-tabs .nav-link {
    border: none;
    border-radius: 0;
    color: var(--azul-escuro);
    font-weight: 500;
    background: var(--cinza-claro);
    padding: 10px 15px;
    transition: all 0.3s ease;
  }
  .nav-tabs .nav-link.active {
    background-color: var(--verde-agro);
    color: white;
  }
  .nav-tabs .nav-link:hover {
    background-color: var(--amarelo-john-deere);
    color: var(--azul-escuro);
  }
  .icon-agro {
    font-size: 1rem;
    margin-right: 6px;
    color: var(--verde-agro);
  }
  .hidden-row { display: none; }

  /* Estilos para o mascote */
  .mascot-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 1.5rem;
    margin-top: 1rem;
  }
  .mascot-icon {
    font-size: 3rem;
    animation: bounce 2s infinite;
  }
  .speech-bubble {
    position: relative;
    padding: 15px;
    border-radius: 10px;
    color: white;
    flex-grow: 1;
  }
  .speech-bubble::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
  }
  .speech-bubble.bubble-success { background-color: #28a745; }
  .speech-bubble.bubble-success::before { border-right: 10px solid #28a745; }
  .speech-bubble.bubble-info { background-color: #17a2b8; }
  .speech-bubble.bubble-info::before { border-right: 10px solid #17a2b8; }
  .speech-bubble.bubble-warning { background-color: #ffc107; color: #212529; }
  .speech-bubble.bubble-warning::before { border-right: 10px solid #ffc107; }

  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
    40% {transform: translateY(-10px);}
    60% {transform: translateY(-5px);}
  }

  @media (max-width: 576px) {
    .stat-card h3 { font-size: 1.3rem; }
    .table-modern { font-size: 0.85rem; }
    .filter-container { flex-direction: column; align-items: stretch; }
    .period-btn { width: 100%; margin-bottom: 5px; }
    .nav-tabs .nav-link { font-size: 0.85rem; padding: 6px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Inicializar Flatpickr
    flatpickr('#date-range', {
      mode: 'range',
      dateFormat: 'Y-m-d',
      locale: {
        firstDayOfWeek: 1,
        weekdays: { shorthand: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'], longhand: ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'] },
        months: { shorthand: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'], longhand: ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'] }
      },
      onChange: (selectedDates) => {
        if (selectedDates.length === 2) {
          const [start, end] = selectedDates;
          const url = new URL(window.location);
          url.searchParams.set('periodo', 'custom');
          url.searchParams.set('data_inicio', start.toISOString().split('T')[0]);
          url.searchParams.set('data_fim', end.toISOString().split('T')[0]);
          window.location = url;
        }
      }
    });

    // Bot√µes de per√≠odo
    const periodButtons = document.querySelectorAll('.period-btn');
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const periodo = btn.dataset.periodo;
        const url = new URL(window.location);
        url.searchParams.set('periodo', periodo);
        url.searchParams.delete('data_inicio');
        url.searchParams.delete('data_fim');
        window.location = url;
      });
    });

    // Chart rendering removed as per user request.

    // Filtro da tabela
    const filterInput = document.querySelector('#filter-os');
    const tableRows = document.querySelectorAll('.table-modern tbody tr');
    filterInput.addEventListener('input', () => {
      const filter = filterInput.value.toLowerCase();
      tableRows.forEach(row => {
        const osNumber = row.cells[0].textContent.toLowerCase();
        const gerente = row.cells[1].textContent.toLowerCase();
        const observacoes = row.cells[4].textContent.toLowerCase();
        row.style.display = (osNumber.includes(filter) || gerente.includes(filter) || observacoes.includes(filter)) ? '' : 'none';
      });
    });

    // Toggle para rankings e tabelas
    const toggleButtons = document.querySelectorAll('.btn-toggle');
    toggleButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetClass = button.getAttribute('data-target');
        const rows = document.querySelectorAll(`tr.${targetClass}`);
        if (rows.length > 0) {
          const isHidden = rows[0].classList.contains('hidden-row');
          rows.forEach(row => row.classList.toggle('hidden-row', !isHidden));
          button.innerHTML = isHidden 
            ? '<i class="fas fa-minus-circle icon-agro"></i> Ver menos' 
            : '<i class="fas fa-plus-circle icon-agro"></i> Ver mais';
        } else {
          console.error(`Nenhuma linha com a classe ${targetClass} encontrada`);
        }
      });
    });
  });

  String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  };
</script>
{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0"><i class="fas fa-tractor icon-agro"></i>Painel de Manuten√ß√£o Agr√≠cola</h2>
    <div>
      <a href="{{ url_for('exportar_os_finalizadas', periodo=periodo, data_inicio=data_inicio, data_fim=data_fim) }}" class="btn btn-agro btn-sm me-2">
        <i class="fas fa-file-export icon-agro"></i>Exportar Relat√≥rio
      </a>
      <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
        <i class="fas fa-sign-out-alt icon-agro"></i>Desconectar
      </a>
    </div>
  </div>

  {# --- Bloco de Sauda√ß√£o com Mascote --- #}
  {% set os_count = os_abertas.values()|sum %}
  {% if os_count == 0 %}
    {% set bubble_class = 'bubble-success' %}
    {% set message = 'Tudo certo por aqui! Nenhuma OS em aberto no sistema. ‚úÖ' %}
  {% elif os_count <= 10 %}
    {% set bubble_class = 'bubble-info' %}
    {% set message = 'Existem ' ~ os_count ~ ' OS em aberto no total. üëç' %}
  {% else %}
    {% set bubble_class = 'bubble-warning' %}
    {% set message = 'Aten√ß√£o! O sistema tem ' ~ os_count ~ ' OS em aberto. Priorize as mais antigas! ‚ö†Ô∏è' %}
  {% endif %}

  <div class="mascot-container">
    <div class="mascot-icon">üöú</div>
    <div class="speech-bubble {{ bubble_class }}">
      <h5 class="fw-bold mb-1">{{ random_greeting }} {{ session.get('gerente')|capitalize_name }}!</h5>
      <p class="mb-0">{{ message }}</p>
    </div>
  </div>
  {# --- Fim do Bloco de Sauda√ß√£o com Mascote --- #}

  <!-- Abas -->
  <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="historico-tab" data-bs-toggle="tab" data-bs-target="#historico" type="button" role="tab" aria-controls="historico" aria-selected="true">
        <i class="fas fa-history icon-agro"></i>Hist√≥rico
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pendencias-tab" data-bs-toggle="tab" data-bs-target="#pendencias" type="button" role="tab" aria-controls="pendencias" aria-selected="false">
        <i class="fas fa-pause-circle icon-agro"></i>Pend√™ncias & Rankings
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="perfil-tab" data-bs-toggle="tab" data-bs-target="#perfil" type="button" role="tab" aria-controls="perfil" aria-selected="false">
        <i class="fas fa-user-circle icon-agro"></i>Meu Perfil
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <a href="{{ url_for('frota_leve') }}" class="nav-link">
        <i class="fas fa-car-side icon-agro"></i>Frota Leve
      </a>
    </li>
  </ul>

  <div class="tab-content" id="adminTabContent">
    <!-- Aba: Hist√≥rico -->
    <div class="tab-pane fade show active" id="historico" role="tabpanel" aria-labelledby="historico-tab">
      <!-- Cart√µes de Estat√≠sticas -->
      <div class="row mb-4">
        <div class="col-md-3 col-sm-6">
          <div class="stat-card primary">
            <h3><i class="fas fa-tools icon-agro"></i>{{ total_os }}</h3>
            <p>Manuten√ß√µes Conclu√≠das</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card success">
            <h3><i class="fas fa-users icon-agro"></i>{{ gerentes|length }}</h3>
            <p>Supervisores Ativos</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card warning">
            <h3><i class="fas fa-calendar-day icon-agro"></i>{{ now.strftime('%d/%m/%Y') }}</h3>
            <p>√öltima Atualiza√ß√£o</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="stat-card danger">
            <h3><i class="fas fa-exclamation-circle icon-agro"></i>{{ os_abertas.values()|sum }}</h3>
            <p>Manuten√ß√µes Pendentes</p>
          </div>
        </div>
      </div>

      <!-- Filtros e Hist√≥rico de Manuten√ß√µes -->
      <div class="card-modern mb-4">
        <div class="card-header historico-os d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-tools icon-agro"></i>Hist√≥rico de Manuten√ß√µes</h4>
          {% if finalizadas|length > 3 %}
          <button class="btn btn-sm btn-toggle" data-target="finalizada-row">
            <i class="fas fa-plus-circle icon-agro"></i> Ver mais
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="filter-container">
            <div class="btn-group">
              <button class="btn period-btn {% if periodo == 'todos' %}active{% endif %}" data-periodo="todos">Todas</button>
              <button class="btn period-btn {% if periodo == 'diario' %}active{% endif %}" data-periodo="diario">Di√°rio</button>
              <button class="btn period-btn {% if periodo == 'semanal' %}active{% endif %}" data-periodo="semanal">Semanal</button>
              <button class="btn period-btn {% if periodo == 'mensal' %}active{% endif %}" data-periodo="mensal">Mensal</button>
              <button class="btn period-btn {% if periodo == 'anual' %}active{% endif %}" data-periodo="anual">Anual</button>
            </div>
            <input type="text" id="date-range" class="flatpickr-input form-control" placeholder="Intervalo de datas" value="{% if data_inicio and data_fim %}{{ data_inicio }} to {{ data_fim }}{% endif %}">
            <input type="text" id="filter-os" class="form-control form-control-sm" placeholder="Filtrar por OS, supervisor ou observa√ß√µes...">
          </div>
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr>
                  <th>OS</th>
                  <th>Supervisor</th>
                  <th>Data</th>
                  <th>Hora</th>
                  <th>Observa√ß√µes</th>
                  <th>Status PIMNS</th>
                </tr>
              </thead>
              <tbody>
                {% for os in finalizadas %}
                <tr class="{% if loop.index > 3 %}finalizada-row hidden-row{% endif %}">
                  <td>{{ os.os_numero }}</td>
                  <td>{{ os.gerente|capitalize_name }}</td>
                  <td>{{ os.data_fin }}</td>
                  <td>{{ os.hora_fin }}</td>
                  <td>{{ os.observacoes or '-' }}</td>
                  <td>
                      <form action="{{ url_for('update_pimns_status', os_id=os.id) }}" method="POST" class="d-flex align-items-center">
                          <input type="checkbox" name="status_pimns" {% if os.status_pimns %}checked{% endif %} onchange="this.form.submit()">
                          <span class="ms-2">{{ 'Marcado' if os.status_pimns else 'Desmarcado' }}</span>
                      </form>
                  </td>
                </tr>
                {% endfor %}
                {% if not finalizadas %}
                <tr><td colspan="5" class="text-center py-3">Nenhuma manuten√ß√£o conclu√≠da</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Hist√≥rico de Logins -->
      <div class="card-modern">
        <div class="card-header historico-logins d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-history icon-agro"></i>Hist√≥rico de Acesso (√öltimos 50)</h4>
          {% if login_events|length > 3 %}
          <button class="btn btn-sm btn-toggle" data-target="login-row">
            <i class="fas fa-plus-circle icon-agro"></i> Ver mais
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr><th>Usu√°rio</th><th>Tipo</th><th>Login</th><th>Logout</th><th>Dura√ß√£o</th></tr>
              </thead>
              <tbody>
                {% for ev in login_events %}
                <tr class="{% if loop.index > 3 %}login-row hidden-row{% endif %}">
                  <td>{{ ev.username|capitalize_name }}</td>
                  <td>{{ ev.user_type.capitalize() }}</td>
                  <td>{{ ev.login_time_formatted }}</td>
                  <td>{% if ev.logout_time_formatted %}{{ ev.logout_time_formatted }}{% else %}<span class="text-muted">ativo</span>{% endif %}</td>
                  <td>{% if ev.duration_secs %}{{ (ev.duration_secs // 3600) }}h {{ ((ev.duration_secs % 3600)//60) }}m {{ (ev.duration_secs % 60) }}s{% else %}<span class="text-muted">‚Äî</span>{% endif %}</td>
                </tr>
                {% endfor %}
                {% if not login_events %}
                <tr><td colspan="5" class="text-center py-3">Nenhum evento de acesso</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba: Pend√™ncias e Rankings -->
    <div class="tab-pane fade" id="pendencias" role="tabpanel" aria-labelledby="pendencias-tab">
      <!-- Tabela de OS Pendentes -->
      {% if os_pendentes_todas %}
      <div class="card-modern mb-4">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-pause-circle icon-agro"></i>Manuten√ß√µes Pendentes Atualmente</h4>
          {% if os_pendentes_todas|length > 5 %}
          <button class="btn btn-sm btn-toggle" data-target="pendente-row">
            <i class="fas fa-plus-circle icon-agro"></i> Ver mais
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern table-sm table-hover">
              <thead>
                <tr><th>OS</th><th>Frota</th><th>Prestador</th><th>Motivo da Pend√™ncia</th><th>Data Status</th></tr>
              </thead>
              <tbody>
                {% for p in os_pendentes_todas %}
                <tr class="{% if loop.index > 5 %}pendente-row hidden-row{% endif %}">
                  <td><span class="badge bg-secondary">{{ p.os }}</span></td>
                  <td>{{ p.frota }}</td>
                  <td>{{ p.status_definido_por | default('N/A') }}</td>
                  <td>{{ p.status_motivo | default('N/A') }}</td>
                  <td>{{ p.status_data | default('N/A') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
      <div class="alert alert-success text-center">
        <i class="fas fa-check-circle fa-2x mb-2"></i>
        <h4 class="alert-heading">Tudo em ordem!</h4>
        <p>Nenhuma ordem de servi√ßo marcada como pendente no momento.</p>
      </div>
      {% endif %}
      <!-- Ranking de OS Pendentes (Supervisores) -->
      <div class="card-modern mb-4">
        <div class="card-header ranking-gerentes d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-trophy icon-agro"></i>Ranking Manuten√ß√µes Pendentes (Supervisores)</h4>
          {% if ranking_os_abertas|length > 3 %}
          <button class="btn btn-sm btn-toggle" data-target="gerente-ranking-row">
            <i class="fas fa-plus-circle icon-agro"></i> Ver mais
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr><th>Posi√ß√£o</th><th>Supervisor</th><th>OS Pendentes</th></tr>
              </thead>
              <tbody>
                {% for gerente, count in ranking_os_abertas %}
                <tr class="{% if loop.index > 3 %}gerente-ranking-row hidden-row{% endif %}">
                  <td><span class="badge badge-ranking {% if loop.index == 1 %}ranking-1{% elif loop.index == 2 %}ranking-2{% elif loop.index == 3 %}ranking-3{% else %}ranking-other{% endif %}">{{ loop.index }}¬∫</span></td>
                  <td>{{ gerente|capitalize_name }}</td>
                  <td>{{ count }} pendente{{ 's' if count != 1 else '' }}</td>
                </tr>
                {% endfor %}
                {% if not ranking_os_abertas %}
                <tr><td colspan="3" class="text-center py-3">Nenhuma OS pendente</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ranking de OS Pendentes (Prestadores) -->
      <div class="card-modern mb-4">
        <div class="card-header ranking-prestadores d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="fas fa-trophy icon-agro"></i>Ranking Manuten√ß√µes Pendentes (Prestadores)</h4>
          {% if ranking_os_prestadores|length > 3 %}
          <button class="btn btn-sm btn-toggle" data-target="prestador-ranking-row">
            <i class="fas fa-plus-circle icon-agro"></i> Ver mais
          </button>
          {% endif %}
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-modern table-sm">
              <thead>
                <tr><th>Posi√ß√£o</th><th>Prestador</th><th>OS Pendentes</th></tr>
              </thead>
              <tbody>
                {% for prestador, count in ranking_os_prestadores %}
                <tr class="{% if loop.index > 3 %}prestador-ranking-row hidden-row{% endif %}">
                  <td><span class="badge badge-ranking {% if loop.index == 1 %}ranking-1{% elif loop.index == 2 %}ranking-2{% elif loop.index == 3 %}ranking-3{% else %}ranking-other{% endif %}">{{ loop.index }}¬∫</span></td>
                  <td>{{ prestador|capitalize_name }}</td>
                  <td>{{ count }} pendente{{ 's' if count != 1 else '' }}</td>
                </tr>
                {% endfor %}
                {% if not ranking_os_prestadores %}
                <tr><td colspan="3" class="text-center py-3">Nenhuma OS pendente</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba: Meu Perfil -->
    <div class="tab-pane fade" id="perfil" role="tabpanel" aria-labelledby="perfil-tab">
      <div class="card-modern">
        <div class="card-header">
          <h4 class="mb-0"><i class="fas fa-camera-retro icon-agro"></i>Sua Foto de Perfil</h4>
        </div>
        <div class="card-body text-center">
          {% if admin_user and admin_user.profile_picture %}
            <img src="{{ url_for('static', filename=admin_user.profile_picture) }}" alt="Foto de Perfil" class="img-thumbnail rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
          {% else %}
            <div class="mb-3">
              <i class="fas fa-user-circle fa-9x text-muted"></i>
            </div>
            <p class="text-muted">Nenhuma foto de perfil definida.</p>
          {% endif %}

          <form action="{{ url_for('upload_profile_picture') }}" method="POST" enctype="multipart/form-data" class="mt-4">
            <div class="mb-3">
              <label for="profile_picture" class="form-label">Escolha uma nova foto (PNG, JPG, GIF):</label>
              <input type="file" class="form-control" name="profile_picture" id="profile_picture" accept=".png,.jpg,.jpeg,.gif" required>
            </div>
            <button type="submit" class="btn btn-agro"><i class="fas fa-upload me-2"></i>Enviar Foto</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
